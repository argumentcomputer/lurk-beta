name: Deploy GPU benchmarks on GH Pages
on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  benchmark:
    name: Bench and deploy
    runs-on: [self-hosted, gpu-bench-t4]
    steps:
      # Install deps
      - uses: actions-rs/toolchain@v1
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@v2
        with:
          tool: just@v1

      # Set up GPU
      # Check we have access to the machine's Nvidia drivers
      - run: nvidia-smi
      # Check that CUDA is installed with a driver-compatible version
      # This must also be compatible with the GPU architecture, see above link
      - run: nvcc --version

      # Run benchmarks and deploy
      - name: Get old benchmarks
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
      - run: mkdir -p target; cp -r gh-pages/benchmarks/criterion target;
      - name: Install criterion
        run: cargo install cargo-criterion
      - name: Run benchmarks
        run: just --dotenv-filename bench.env gpu-bench fibonacci
      - name: Compress artifacts
        run: tar -cvzf ${{ github.sha }}.tar.gz Cargo.lock ${{ github.sha }}.json
      - name: Deploy latest benchmark report
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/criterion
          destination_dir: benchmarks/criterion
      - name: Move benchmark json to history
        run: mkdir history; cp ${{ github.sha }}.tar.gz history/
      - name: Deploy benchmark history
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: history/
          destination_dir: benchmarks/history
          keep_files: true
